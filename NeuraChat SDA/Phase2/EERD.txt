erDiagram
    %% CORE USER & AUTH
    users {
        uuid id PK "Supabase Auth ID"
        string email
        string username 
        string fullName
        string password 
        string avatar_url
        string status_message
        timestamp last_seen
        timestamp created_at
        text ai_provider
        text ai_model
    }

    %% LINKING USERS TO CHATS (Crucial missing piece)
    chat_participants {
        uuid chat_id FK
        uuid user_id FK
        string role "admin | member"
        timestamp joined_at
    }

    notifications {
        uuid id PK
        uuid user_id FK
        string title
        string content
        string type "message | call | system"
        boolean is_read
        timestamp created_at
    }

    %% SECURITY (Signal Protocol)
    encryption_keys {
        uuid id PK
        uuid user_id FK
        text identity_key "Public Identity Key"
        text signed_pre_key
        jsonb one_time_pre_keys "Batch of keys"
        timestamp updated_at
    }

    %% CHAT & MESSAGING
    chats {
        uuid id PK
        string type "private | group"
        string name "Group Name"
        timestamp created_at
    }

    messages {
        uuid id PK
        uuid chat_id FK
        uuid sender_id FK
        text content "Encrypted payload"
        string type "text | media | system"
        string status "sent  delivered | read"
        timestamp created_at
        timestamp updated_at
    }

    media_files {
        uuid id PK
        uuid message_id FK
        string file_url "Supabase Storage Path"
        string file_type
        int file_size
        timestamp uploaded_at
    }

    %% AI FEATURES (Enhancement & Summarization)



    %% DEDICATED AI AGENT
    ai_agent_sessions {
        uuid id PK
        uuid user_id FK
        string title
        timestamp created_at
        timestamp updated_at
    }

    ai_interactions {
        uuid id PK
        uuid session_id FK
        text user_query
        text ai_response
        string intent "info | writing | productivity"
        timestamp created_at
    }

    %% CALLING & WEBRTC
    calls {
        uuid id PK
        uuid chat_id FK
        uuid initiator_id FK
        string status "active | ended"
        string type "audio | video"
        timestamp start_time
        timestamp end_time
    }

    call_participants {
        uuid call_id FK
        uuid user_id FK
        string status "connecting | connected | left | rejected"
        timestamp joined_at
    }

    call_logs {
        uuid id PK
        uuid call_id FK
        string quality_rating
        int duration_seconds
        timestamp created_at
    }

    %% RELATIONSHIPS
    users ||--o{ notifications : receives
    users ||--o{ encryption_keys : owns
    chats ||--o{ messages : contains
    users ||--o{ messages : sends
    messages ||--o{ media_file : attachments
    users ||--o{ ai_agent_sessions : initiates
    ai_agent_sessions ||--o{ ai_interactions : logs
    chats ||--o{ calls : hosts
    calls ||--o{ call_participants : involves
    calls ||--o| call_logs : records
    users ||--o{ chat_participants : joins
    chats ||--o{ chat_participants : has
