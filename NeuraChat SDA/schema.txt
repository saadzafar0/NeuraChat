-- 1. ENABLE EXTENSIONS (If needed for UUIDs)
create extension if not exists "uuid-ossp";

-- 2. USERS (Public Profile - Syncs with Auth)
create table public.users (
  id uuid references auth.users not null primary key, -- FK to internal Auth
  email text,
  username text unique,
  full_name text,
  avatar_url text,
  status_message text,
  last_seen timestamptz default now(),
  created_at timestamptz default now()
);

-- 3. ENCRYPTION KEYS (Signal Protocol)
create table public.encryption_keys (
  id uuid default gen_random_uuid() primary key,
  user_id uuid references public.users(id) on delete cascade not null,
  identity_key text not null,      -- Public Identity Key
  signed_pre_key text not null,    -- Signed Pre Key
  one_time_pre_keys jsonb,         -- Batch of One-Time Pre Keys
  updated_at timestamptz default now()
);

-- 4. CHATS
create table public.chats (
  id uuid default gen_random_uuid() primary key,
  type text check (type in ('private', 'group')) not null,
  name text, -- Nullable (only used for Groups)
  created_at timestamptz default now()
);

-- 5. CHAT PARTICIPANTS (Join Table)
create table public.chat_participants (
  chat_id uuid references public.chats(id) on delete cascade not null,
  user_id uuid references public.users(id) on delete cascade not null,
  role text default 'member' check (role in ('admin', 'member')),
  joined_at timestamptz default now(),
  primary key (chat_id, user_id) -- Composite PK prevents duplicate joins
);

-- 6. MESSAGES
create table public.messages (
  id uuid default gen_random_uuid() primary key,
  chat_id uuid references public.chats(id) on delete cascade not null,
  sender_id uuid references public.users(id) not null,
  content text not null, -- Stores the Signal Protocol Encrypted String
  type text default 'text' check (type in ('text', 'media', 'system')),
  status text default 'sent' check (status in ('sent', 'delivered', 'read')),
  created_at timestamptz default now(),
  updated_at timestamptz default now()
);

-- 7. MEDIA FILES
create table public.media_files (
  id uuid default gen_random_uuid() primary key,
  message_id uuid references public.messages(id) on delete cascade not null,
  file_url text not null, -- Path to Supabase Storage Bucket
  file_type text,
  file_size int,
  uploaded_at timestamptz default now()
);

-- 8. NOTIFICATIONS
create table public.notifications (
  id uuid default gen_random_uuid() primary key,
  user_id uuid references public.users(id) on delete cascade not null,
  title text not null,
  content text,
  type text check (type in ('message', 'call', 'system')),
  is_read boolean default false,
  created_at timestamptz default now()
);

-- 9. AI AGENT SESSIONS
create table public.ai_agent_sessions (
  id uuid default gen_random_uuid() primary key,
  user_id uuid references public.users(id) on delete cascade not null,
  title text,
  created_at timestamptz default now(),
  updated_at timestamptz default now()
);

-- 10. AI INTERACTIONS (Chat history with AI)
create table public.ai_interactions (
  id uuid default gen_random_uuid() primary key,
  session_id uuid references public.ai_agent_sessions(id) on delete cascade not null,
  user_query text not null,
  ai_response text not null,
  intent text check (intent in ('info', 'writing', 'productivity')),
  created_at timestamptz default now()
);

-- 11. CALLS (Active WebRTC Sessions)
create table public.calls (
  id uuid default gen_random_uuid() primary key,
  chat_id uuid references public.chats(id) on delete cascade not null,
  initiator_id uuid references public.users(id) not null,
  status text default 'active' check (status in ('active', 'ended')),
  type text default 'audio' check (type in ('audio', 'video')),
  start_time timestamptz default now(),
  end_time timestamptz
);

-- 12. CALL PARTICIPANTS (Who is in the call?)
create table public.call_participants (
  call_id uuid references public.calls(id) on delete cascade not null,
  user_id uuid references public.users(id) not null,
  status text default 'connecting' check (status in ('connecting', 'connected', 'left', 'rejected')),
  joined_at timestamptz default now(),
  primary key (call_id, user_id)
);

-- 13. CALL LOGS (Historical Data)
create table public.call_logs (
  id uuid default gen_random_uuid() primary key,
  call_id uuid references public.calls(id) unique not null,
  quality_rating text, -- e.g., 'good', 'poor'
  duration_seconds int,
  created_at timestamptz default now()
);

-- 14. SECURITY: ENABLE ROW LEVEL SECURITY (RLS)
-- Mandatory for Supabase. This locks tables down by default.
alter table public.users enable row level security;
alter table public.encryption_keys enable row level security;
alter table public.chats enable row level security;
alter table public.chat_participants enable row level security;
alter table public.messages enable row level security;
alter table public.media_files enable row level security;
alter table public.notifications enable row level security;
alter table public.ai_agent_sessions enable row level security;
alter table public.ai_interactions enable row level security;
alter table public.calls enable row level security;
alter table public.call_participants enable row level security;
alter table public.call_logs enable row level security;

-- 15. AUTOMATION: Sync Auth User to Public User
create or replace function public.handle_new_user() 
returns trigger as $$
begin
  insert into public.users (id, email, username, full_name, avatar_url)
  values (
    new.id, 
    new.email, 
    new.raw_user_meta_data->>'username', 
    new.raw_user_meta_data->>'full_name',
    new.raw_user_meta_data->>'avatar_url'
  );
  return new;
end;
$$ language plpgsql security definer;

-- Trigger the function every time a user signs up
create trigger on_auth_user_created
  after insert on auth.users
  for each row execute procedure public.handle_new_user();